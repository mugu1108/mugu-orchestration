# /plan - 実装計画作成コマンド

**説明**: 複雑な機能や実装タスクの詳細な計画を作成します。

## 使用方法

```
/plan [機能の説明]
```

## 概要

`/plan` コマンドは、Plannerエージェントを呼び出し、実装に入る前に詳細な計画を作成します。要件分析、アーキテクチャ設計、ステップ分解を行い、高品質で構造化された計画を提供します。

## いつ使うか

- **複雑な新機能の実装**: 複数のファイルやモジュールにまたがる変更
- **大規模なリファクタリング**: コードベース全体に影響する変更
- **新しい統合や機能追加**: 外部APIやサービスの統合
- **セキュリティやパフォーマンスの改善**: 重要な変更を計画的に実施

## 使用例

### 例1: 新機能の計画

```
/plan 時間追跡データから請求書を自動生成する機能を追加したい
```

**出力**:
```markdown
# 請求書生成機能 実装計画

## 1. 要件
- Supabaseの時間追跡データを取得
- PDF形式で請求書を出力
- テンプレートのカスタマイズ可能

## 2. アーキテクチャ
### 新規コンポーネント
- `src/invoicing/` - 請求書生成ロジック
- `src/invoicing/templates/` - PDFテンプレート
- `src/invoicing/data-fetcher.ts` - Supabaseからデータ取得

### 依存関係
- jspdf - PDF生成ライブラリ
- @supabase/supabase-js - Supabaseクライアント

## 3. 実装ステップ
### ステップ1: データ取得機能の実装
- Supabaseから時間追跡データを取得
- データの集計とフォーマット

### ステップ2: PDF生成機能の実装
- PDFテンプレートの作成
- データをテンプレートに注入

### ステップ3: テストとドキュメント
- ユニットテストの作成
- README更新

## 4. テスト戦略
- ユニットテスト: データ取得、PDF生成
- 統合テスト: エンドツーエンドのフロー

## 5. リスクと懸念事項
- リスク1: Supabaseの接続エラー → エラーハンドリングを実装
- リスク2: PDFフォーマットの互換性 → 複数のPDFビューアでテスト
```

### 例2: リファクタリングの計画

```
/plan 認証ロジックをリファクタリングして、コードの重複を削減したい
```

**出力**:
```markdown
# 認証ロジックリファクタリング 実装計画

## 1. 要件
- 重複した認証コードを統合
- 保守性の向上
- 既存機能の動作を維持

## 2. 現状分析
- 影響を受けるファイル:
  - `src/auth/login.ts`
  - `src/auth/register.ts`
  - `src/auth/password-reset.ts`
- 重複コード: JWTトークン検証、セッション管理

## 3. リファクタリング計画
### ステップ1: 共通ロジックの抽出
- `src/auth/auth-utils.ts` を作成
- トークン検証関数を統合

### ステップ2: 既存コードの更新
- 各ファイルで共通ロジックを使用

### ステップ3: テストの更新
- 新しい共通関数のテスト追加
- 既存のテストが全て通過することを確認

## 4. ロールバック手順
- Git コミットを分割
- 問題があれば部分的にrevert可能
```

### 例3: セキュリティ改善の計画

```
/plan XSS脆弱性を修正し、セキュリティを強化したい
```

**出力**:
```markdown
# XSS脆弱性修正 実装計画

## 1. 脆弱性の特定
- ユーザー入力が適切にエスケープされていない箇所を特定
- 影響範囲の評価

## 2. 修正計画
### ステップ1: 入力バリデーション
- すべてのユーザー入力にバリデーションを追加
- サニタイズライブラリの導入（DOMPurify）

### ステップ2: 出力エスケープ
- HTMLエスケープの実装
- テンプレートエンジンの適切な使用

### ステップ3: CSPの設定
- Content Security Policyヘッダーの追加
- インラインスクリプトの削除

## 3. テスト戦略
- セキュリティテスト: XSSペイロードでテスト
- 統合テスト: 既存機能が影響を受けないことを確認

## 4. リスク軽減
- 段階的なロールアウト
- セキュリティレビューの実施
```

## 計画の活用方法

### 1. 計画のレビュー
- 計画を確認し、不明点を質問
- 必要に応じて計画を調整

### 2. 段階的な実装
- 計画のステップに従って実装
- 各ステップ後にコミット

### 3. テストと検証
- 計画に含まれるテスト戦略を実行
- 品質を確保

### 4. ドキュメント更新
- 計画に基づいてドキュメントを更新
- doc-updaterエージェントを活用

## ベストプラクティス

1. **明確な目的**: 何を達成したいかを明確に伝える
2. **コンテキスト提供**: 既存のコードや制約を説明
3. **計画の調整**: 実装中に新しい情報が判明したら計画を更新
4. **段階的な実装**: 大きな変更は小さなステップに分割

## 関連エージェント

- **planner**: このコマンドが呼び出すエージェント
- **code-reviewer**: 実装後のコード品質チェック
- **security-reviewer**: セキュリティリスクの評価
- **doc-updater**: ドキュメントの自動更新

## モデル選択

計画作成には、高品質な分析が必要なため、**Opus**モデルの使用を推奨します。

## 詳細情報

詳細は [agents/planner.md](../agents/planner.md) を参照してください。
