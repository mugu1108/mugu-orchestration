---
name: plan
description: 複雑な機能や実装タスクの詳細な計画を作成します
category: workflow
triggers:
  - "plan"
  - "実装計画"
  - "計画作成"
  - "プランニング"
tools:
  - Read
  - Grep
  - Glob
  - Task
  - AskUserQuestion
---

# /plan - 実装計画作成コマンド

**説明**: 複雑な機能や実装タスクの詳細な計画を作成します。

## 使用方法

```
/plan [機能の説明]
```

## 概要

`/plan` コマンドは、Plannerエージェントを呼び出し、実装に入る前に詳細な計画を作成します。要件分析、アーキテクチャ設計、ステップ分解を行い、高品質で構造化された計画を提供します。

## 起動タイミング

- **複雑な新機能の実装**: 複数のファイルやモジュールにまたがる変更
- **大規模なリファクタリング**: コードベース全体に影響する変更
- **新しい統合や機能追加**: 外部APIやサービスの統合
- **セキュリティやパフォーマンスの改善**: 重要な変更を計画的に実施

## 前提条件

- 実装したい機能や変更の概要が明確である
- プロジェクトの既存のコードベースが理解されている
- 関連するルールファイル（rules/）が設定されている

## ワークフローステップ

### ステップ1: 要件の収集

ユーザーから機能の説明を受け取り、必要に応じてAskUserQuestionツールで詳細を確認します:

- 機能の目的と範囲
- 技術的な制約
- 優先事項（セキュリティ、パフォーマンス、保守性など）

### ステップ2: Plannerエージェントの呼び出し

Taskツールを使用してplannerエージェントを起動します:

```
Task(
  subagent_type="Plan",
  description="Implementation planning",
  prompt="agents/planner.mdの指示に従って、以下の機能の実装計画を作成してください: [機能説明]"
)
```

### ステップ3: コードベースの分析

Plannerエージェントは以下を分析します:

1. **既存コード**: 関連するファイルとモジュールの特定
2. **アーキテクチャ**: 現在の構造との整合性確認
3. **依存関係**: 必要なライブラリやサービスの特定
4. **影響範囲**: 変更が影響するコンポーネントの評価

### ステップ4: 計画の作成

以下の構造で詳細な計画を生成します:

```markdown
# [機能名] 実装計画

## 1. 要件
- 機能の概要
- 実装の目的
- 成功基準

## 2. アーキテクチャ
### 新規コンポーネント
- [ファイル/モジュールのリスト]

### 変更が必要なコンポーネント
- [既存ファイルのリスト]

### 依存関係
- [必要なライブラリやサービス]

## 3. 実装ステップ
### ステップ1: [ステップ名]
- 詳細な実装内容
- 必要なファイル操作

### ステップ2: [ステップ名]
- 詳細な実装内容
- 必要なファイル操作

[...]

## 4. テスト戦略
- ユニットテスト
- 統合テスト
- E2Eテスト

## 5. リスクと懸念事項
- リスク1: [説明] → [軽減策]
- リスク2: [説明] → [軽減策]

## 6. ドキュメント更新
- 更新が必要なドキュメント
```

### ステップ5: 計画の提示とフィードバック

生成された計画をユーザーに提示し、必要に応じて調整します。

## 使用例

### 例1: 新機能の計画

```
ユーザー: /plan 時間追跡データから請求書を自動生成する機能を追加したい

エージェント: [plannerエージェントを呼び出し、計画を作成]

# 請求書生成機能 実装計画

## 1. 要件
- Supabaseの時間追跡データを取得
- PDF形式で請求書を出力
- テンプレートのカスタマイズ可能

## 2. アーキテクチャ
### 新規コンポーネント
- `src/invoicing/` - 請求書生成ロジック
- `src/invoicing/templates/` - PDFテンプレート
- `src/invoicing/data-fetcher.ts` - Supabaseからデータ取得

### 依存関係
- jspdf - PDF生成ライブラリ
- @supabase/supabase-js - Supabaseクライアント

## 3. 実装ステップ
[...]
```

### 例2: リファクタリングの計画

```
ユーザー: /plan 認証ロジックをリファクタリングして、コードの重複を削減したい

エージェント: [plannerエージェントが現状分析し、リファクタリング計画を作成]
```

## 計画の活用方法

### 1. 計画のレビュー
- 計画を確認し、不明点を質問
- 必要に応じて計画を調整

### 2. 段階的な実装
- 計画のステップに従って実装
- 各ステップ後にコミット

### 3. テストと検証
- 計画に含まれるテスト戦略を実行
- 品質を確保

### 4. ドキュメント更新
- 計画に基づいてドキュメントを更新
- doc-updaterエージェントを活用

## ベストプラクティス

1. **コンテキスト提供**: 既存のコードや制約を説明
2. **計画の調整**: 実装中に新しい情報が判明したら計画を更新
3. **段階的な実装**: 大きな変更は小さなステップに分割

## 関連エージェント

- **planner**: このコマンドが呼び出すエージェント
- **code-reviewer**: 実装後のコード品質チェック
- **security-reviewer**: セキュリティリスクの評価
- **doc-updater**: ドキュメントの自動更新

## モデル選択

計画作成には、高品質な分析が必要なため、**Opus**モデルの使用を推奨します。

## 詳細情報

詳細は [agents/planner.md](../../agents/planner.md) および [commands/plan.md](../../commands/plan.md) を参照してください。
